<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login System dengan Validasi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }
        
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-status {
            display: flex;
            align-items: center;
            margin-top: 5px;
            font-size: 14px;
            min-height: 20px;
        }
        
        .status-icon {
            margin-right: 5px;
            font-size: 16px;
        }
        
        .status-valid {
            color: #10b981;
        }
        
        .status-invalid {
            color: #ef4444;
        }
        
        .status-checking {
            color: #f59e0b;
        }
        
        .validation-results {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .validation-results.show {
            display: block;
        }
        
        .validation-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 4px;
        }
        
        .validation-item:last-child {
            margin-bottom: 0;
        }
        
        .validation-icon {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .validation-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .validation-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .validation-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .remember-me {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .remember-me input {
            width: auto;
            margin-right: 10px;
        }
        
        .remember-me label {
            margin-bottom: 0;
            font-size: 14px;
            color: #666;
            cursor: pointer;
        }
        
        .btn-login {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn-login:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-login:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        
        .message.show {
            display: block;
        }
        
        .success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 15px 0;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .validation-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-bottom: 3px solid #e5e7eb;
            color: #9ca3af;
            font-size: 14px;
            font-weight: 500;
        }
        
        .step.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .step.completed {
            color: #10b981;
            border-bottom-color: #10b981;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h2>üîê Login System dengan Validasi</h2>
        
        <div class="validation-steps">
            <div class="step" id="step1">1. Cek User</div>
            <div class="step" id="step2">2. Cek Password</div>
            <div class="step" id="step3">3. Cek Link</div>
        </div>
        
        <div class="validation-results" id="validationResults">
            <!-- Hasil validasi akan muncul di sini -->
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="userId">ID Pengguna</label>
                <input type="text" id="userId" required placeholder="Masukkan ID Anda">
                <div class="input-status" id="userIdStatus"></div>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required placeholder="Masukkan password">
                <div class="input-status" id="passwordStatus"></div>
            </div>
            
            <div class="remember-me">
                <input type="checkbox" id="rememberMe" checked>
                <label for="rememberMe">Ingat Saya (3 bulan)</label>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Memvalidasi login...</p>
            </div>
            
            <button type="submit" class="btn-login" id="btnSubmit">Login</button>
            
            <div id="message" class="message"></div>
        </form>
    </div>

    <script>
        // Ganti dengan URL Google Apps Script Anda
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx9StpraMJgVsckIW1eaf5kFym-FJmMX4E4CS-q6xE1l2A7FL4yjVSaeV73JkNvVlA/exec';
        const REMEMBER_DAYS = 90;
        
        // Cache untuk menyimpan hasil validasi
        let validationCache = {
            userExists: null,
            passwordCorrect: null,
            linkExists: null
        };
        
        // Fungsi untuk menampilkan status input
        function showInputStatus(elementId, message, type = '') {
            const element = document.getElementById(elementId);
            element.innerHTML = message ? 
                `<span class="status-icon ${type}">${getStatusIcon(type)}</span> ${message}` : 
                '';
            element.className = `input-status ${type}`;
        }
        
        function getStatusIcon(type) {
            switch(type) {
                case 'status-valid': return '‚úÖ';
                case 'status-invalid': return '‚ùå';
                case 'status-checking': return '‚è≥';
                default: return '';
            }
        }
        
        // Fungsi untuk update progress steps
        function updateProgressSteps(step) {
            const steps = document.querySelectorAll('.step');
            steps.forEach((s, index) => {
                s.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    s.classList.add('completed');
                } else if (index + 1 === step) {
                    s.classList.add('active');
                }
            });
        }
        
        // Fungsi 1: Cek apakah user ada
        async function checkUserExists(userId) {
            updateProgressSteps(1);
            showInputStatus('userIdStatus', 'Memeriksa user...', 'status-checking');
            
            try {
                const response = await fetch(
  `${APPS_SCRIPT_URL}?action=login&userId=${encodeURIComponent(userId)}&password=${encodeURIComponent(password)}`
);
                });
                
                const result = await response.json();
                
                if (result.success) {
                    validationCache.userExists = true;
                    showInputStatus('userIdStatus', '‚úì User ditemukan', 'status-valid');
                    return result.data;
                } else {
                    validationCache.userExists = false;
                    showInputStatus('userIdStatus', result.message, 'status-invalid');
                    return null;
                }
            } catch (error) {
                showInputStatus('userIdStatus', 'Gagal memeriksa user', 'status-invalid');
                return null;
            }
        }
        
        // Fungsi 2: Cek link user
        async function checkUserLink(userId) {
            updateProgressSteps(3);
            
            try {
                const response = await fetch(
  `${APPS_SCRIPT_URL}?action=login&userId=${encodeURIComponent(userId)}&password=${encodeURIComponent(password)}`
);
                
                const result = await response.json();
                
                if (result.success && result.data.link) {
                    validationCache.linkExists = true;
                    return result.data;
                } else {
                    validationCache.linkExists = false;
                    return result;
                }
            } catch (error) {
                validationCache.linkExists = false;
                return null;
            }
        }
        
        // Fungsi untuk menampilkan hasil validasi
        function showValidationResults(results) {
            const container = document.getElementById('validationResults');
            container.innerHTML = '';
            
            if (!results) return;
            
            // Tambahkan hasil validasi
            const items = [];
            
            // Validasi 1: User exists
            items.push({
                icon: validationCache.userExists ? '‚úÖ' : '‚ùå',
                text: validationCache.userExists ? 'User ditemukan di database' : 'User tidak ditemukan',
                type: validationCache.userExists ? 'validation-success' : 'validation-error'
            });
            
            // Validasi 2: Password correct
            if (validationCache.userExists !== null) {
                items.push({
                    icon: validationCache.passwordCorrect ? '‚úÖ' : '‚ùå',
                    text: validationCache.passwordCorrect ? 'Password benar' : 'Password salah',
                    type: validationCache.passwordCorrect ? 'validation-success' : 'validation-error'
                });
            }
            
            // Validasi 3: Link exists
            if (validationCache.userExists && validationCache.passwordCorrect !== null) {
                items.push({
                    icon: validationCache.linkExists ? '‚úÖ' : '‚ùå',
                    text: validationCache.linkExists ? 'Link tersedia' : 'Link tidak tersedia',
                    type: validationCache.linkExists ? 'validation-success' : 'validation-error'
                });
            }
            
            // Render items
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = `validation-item ${item.type}`;
                div.innerHTML = `
                    <span class="validation-icon">${item.icon}</span>
                    <span>${item.text}</span>
                `;
                container.appendChild(div);
            });
            
            container.classList.add('show');
        }
        
        // Fungsi untuk menampilkan pesan
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = text;
            messageDiv.className = `message ${type} show`;
            
            // Auto hide setelah 5 detik untuk error
            if (type === 'error') {
                setTimeout(() => {
                    messageDiv.classList.remove('show');
                }, 5000);
            }
        }
        
        // Cookie functions (sama seperti sebelumnya)
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/";
        }
        
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i].trim();
                if (c.indexOf(nameEQ) === 0) {
                    return decodeURIComponent(c.substring(nameEQ.length));
                }
            }
            return null;
        }
        
        // Validasi real-time saat user mengetik
        let checkUserTimeout;
        document.getElementById('userId').addEventListener('input', function(e) {
            const userId = e.target.value.trim();
            
            // Clear timeout sebelumnya
            clearTimeout(checkUserTimeout);
            
            // Set timeout untuk debounce
            if (userId.length >= 3) {
                checkUserTimeout = setTimeout(() => {
                    checkUserExists(userId);
                }, 500);
            } else {
                showInputStatus('userIdStatus', '', '');
            }
        });
        
        // Handle form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('userId').value.trim();
            const password = document.getElementById('password').value.trim();
            const rememberMe = document.getElementById('rememberMe').checked;
            const loading = document.getElementById('loading');
            const btnSubmit = document.getElementById('btnSubmit');
            
            // Reset validasi
            validationCache = {
                userExists: null,
                passwordCorrect: null,
                linkExists: null
            };
            
            // Validasi input kosong
            if (!userId) {
                showMessage('ID pengguna tidak boleh kosong', 'error');
                showInputStatus('userIdStatus', 'ID pengguna wajib diisi', 'status-invalid');
                return;
            }
            
            if (!password) {
                showMessage('Password tidak boleh kosong', 'error');
                showInputStatus('passwordStatus', 'Password wajib diisi', 'status-invalid');
                return;
            }
            
            // Tampilkan loading
            loading.style.display = 'block';
            btnSubmit.disabled = true;
            
            try {
                // Step 1: Cek user
                updateProgressSteps(1);
                const userCheck = await checkUserExists(userId);
                
                if (!userCheck || !validationCache.userExists) {
                    showMessage('User tidak ditemukan. Periksa ID pengguna Anda.', 'error');
                    showValidationResults();
                    loading.style.display = 'none';
                    btnSubmit.disabled = false;
                    return;
                }
                
                // Step 2: Login dengan password
                updateProgressSteps(2);
                showInputStatus('passwordStatus', 'Memverifikasi password...', 'status-checking');
                
                const loginResponse = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'login',
                        userId: userId,
                        password: password
                    })
                });
                
                const loginResult = await loginResponse.json();
                
                // Tampilkan semua hasil validasi
                showValidationResults(loginResult.data?.validations);
                
                if (loginResult.success) {
                    // Step 3: Semua validasi berhasil
                    updateProgressSteps(3);
                    validationCache.passwordCorrect = true;
                    validationCache.linkExists = true;
                    
                    showInputStatus('passwordStatus', '‚úì Password benar', 'status-valid');
                    showMessage(loginResult.message, 'success');
                    
                    // Save credentials if remember me
                    if (rememberMe) {
                        // Enkripsi sederhana
                        const encryptedPassword = btoa(unescape(encodeURIComponent(password)));
                        setCookie('savedUserId', userId, REMEMBER_DAYS);
                        setCookie('savedPassword', encryptedPassword, REMEMBER_DAYS);
                        setCookie('autoLogin', 'true', REMEMBER_DAYS);
                    }
                    
                    // Tunggu 2 detik sebelum redirect
                    setTimeout(() => {
                        window.location.href = loginResult.data.link;
                    }, 2000);
                    
                } else {
                    // Tentukan jenis error
                    validationCache.passwordCorrect = loginResult.data?.validations?.passwordCorrect || false;
                    validationCache.linkExists = loginResult.data?.validations?.linkExists || false;
                    
                    if (validationCache.userExists && !validationCache.passwordCorrect) {
                        showInputStatus('passwordStatus', '‚úó Password salah', 'status-invalid');
                        showMessage('Password yang Anda masukkan salah.', 'error');
                    } else if (validationCache.userExists && validationCache.passwordCorrect && !validationCache.linkExists) {
                        showMessage('User valid tetapi link tidak tersedia. Hubungi administrator.', 'error');
                    } else {
                        showMessage(loginResult.message || 'Login gagal.', 'error');
                    }
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Terjadi kesalahan sistem. Silakan coba lagi.', 'error');
            } finally {
                loading.style.display = 'none';
                btnSubmit.disabled = false;
            }
        });
        
        // Load saved credentials on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedUserId = getCookie('savedUserId');
            const savedPassword = getCookie('savedPassword');
            
            if (savedUserId && savedPassword) {
                try {
                    const decryptedPassword = decodeURIComponent(escape(atob(savedPassword)));
                    document.getElementById('userId').value = savedUserId;
                    document.getElementById('password').value = decryptedPassword;
                    
                    // Auto-check user existence
                    setTimeout(() => {
                        checkUserExists(savedUserId);
                    }, 1000);
                } catch (e) {
                    console.error('Error loading saved credentials:', e);
                }
            }
        });
    </script>
</body>
</html>

